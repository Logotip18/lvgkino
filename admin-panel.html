<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è - LVG Kino</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            background: #1a1a2e;
            color: white;
            min-height: 100vh;
            padding: 15px;
            position: relative;
        }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: -1;
        }
        .container {
            max-width: 1200px; margin: 0 auto; background: rgba(0, 0, 0, 0.7);
            border-radius: 15px; padding: 15px;
        }
        .back-link {
            display: inline-block; margin-bottom: 15px; color: #4ecdc4; text-decoration: none;
            padding: 8px 15px; border: 1px solid #4ecdc4; border-radius: 5px; transition: all 0.3s; font-size: 0.9rem;
        }
        .back-link:hover { background: rgba(78, 205, 196, 0.1); }
        header { text-align: center; padding: 15px 0; margin-bottom: 20px; position: relative; }
        h1 { font-size: 1.8rem; margin-bottom: 10px; color: #4ecdc4; }
        .admin-menu {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px; margin-bottom: 20px;
        }
        .menu-item {
            background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 15px;
            text-align: center; cursor: pointer; transition: all 0.3s; min-height: 80px;
            display: flex; flex-direction: column; justify-content: center;
        }
        .menu-item:hover { background: rgba(255, 255, 255, 0.1); transform: translateY(-3px); }
        .menu-item h3 { color: #ff6b6b; margin-bottom: 8px; font-size: 1.2rem; }
        .menu-item p { font-size: 0.9rem; opacity: 0.9; }
        .section { background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px; display: none; }
        .section.active { display: block; }
        .section h2 { color: #4ecdc4; margin-bottom: 15px; font-size: 1.5rem; text-align: center; }
        .table-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 15px 0; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 6px 4px; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); white-space: nowrap; }
        th { background: rgba(78, 205, 196, 0.2); font-size: 0.8rem; }
        .logout-btn {
            background: #ff6b6b; color: white; border: none; padding: 8px 15px; border-radius: 5px;
            cursor: pointer; position: absolute; top: 0; right: 0; font-size: 0.9rem;
        }
        .logout-btn:hover { background: #ff5252; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        input, select, textarea {
            width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #4ecdc4; background: rgba(0, 0, 0, 0.3); color: white; font-size: 0.9rem;
        }
        button {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4); color: white; border: none; padding: 10px 20px; border-radius: 25px;
            cursor: pointer; font-weight: bold; margin: 5px; font-size: 0.9rem; min-height: 40px;
        }
        button:hover { transform: translateY(-2px); }
        button[disabled] { opacity: 0.6; cursor: not-allowed; transform: none; }
        .success-message { background: rgba(76, 175, 80, 0.2); padding: 10px; border-radius: 5px; margin: 10px 0; display: none; font-size: 0.9rem; }
        .error-message { background: rgba(255, 107, 107, 0.2); padding: 10px; border-radius: 5px; margin: 10px 0; display: none; font-size: 0.9rem; }
        .loading { text-align: center; padding: 20px; font-size: 1rem; }
        .nav-buttons { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center; }
        .nav-button {
            background: rgba(78, 205, 196, 0.2); color: white; border: 1px solid #4ecdc4; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem;
        }
        .nav-button.active { background: linear-gradient(45deg, #ff6b6b, #4ecdc4); }
        .refresh-btn { background: #4ecdc4; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; margin-left: 10px; }
        .filters-container { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-bottom: 20px; align-items: center; }
        .filter-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }

        /* Hall modal */
        .hall-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); overflow: auto; }
        .hall-modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); margin: 2% auto; padding: 20px; border-radius: 15px; width: 95%; max-width: 1000px; text-align: center; border: 1px solid #4ecdc4; position: relative;
        }
        .hall-modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; top: 10px; right: 15px; }
        .hall-modal-close:hover, .hall-modal-close:focus { color: #4ecdc4; }
        .hall-modal-header { margin-bottom: 20px; }
        .hall-modal-header h2 { color: #4ecdc4; margin: 0; }
        .hall-modal-screen {
            background: linear-gradient(180deg, #4a90e2, #2c5aa0); height: 40px; width: 90%; margin: 0 auto 20px; border-radius: 5px; text-align: center; line-height: 40px; font-weight: bold; box-shadow: 0 0 10px rgba(74, 144, 226, 0.5); font-size: 0.9rem;
        }
        .hall-modal-row { display: flex; justify-content: center; margin-bottom: 8px; gap: 6px; }
        .hall-modal-seat {
            background: #555; border: 1px solid #777; border-radius: 4px; text-align: center; font-size: 10px; display: flex; align-items: center; justify-content: center; user-select: none; transition: all 0.2s;
        }
        .hall-modal-seat.available { background: #4ecdc4; cursor: pointer; }
        .hall-modal-seat.available:hover { background: #48bfb3; transform: scale(1.1); }
        .hall-modal-seat.booked { cursor: pointer; }
        .hall-modal-seat.booked.confirmed { background: #ff6b6b; }
        .hall-modal-seat.booked.pending { background: #ff9800; }
        .hall-modal-seat.booked:hover { transform: scale(1.1); }
        .hall-modal-row-label { width: 20px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #4ecdc4; font-size: 0.7rem; }
        .hall-modal-single { width: 30px; height: 30px; }
        .hall-modal-double { width: 65px; height: 30px; }
        .hall-modal-quad { width: 135px; height: 30px; }
        .hall-modal-seat.highlighted {
            box-shadow: 0 0 0 3px #FFD700, 0 0 15px #FFD700; position: relative; z-index: 10;
        }
        .hall-modal-seat.highlighted::after {
            content: "üìç"; position: absolute; top: -15px; left: 50%; transform: translateX(-50%); font-size: 16px; animation: pulseHighlight 1.5s infinite;
        }
        @keyframes pulseHighlight { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* Info and create modals */
        .booking-info-modal, .booking-create-modal {
            display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); padding: 20px; overflow: auto;
        }
        .booking-info-modal-content, .booking-create-modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 40px auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 480px;
            text-align: center;
            border: 1px solid #4ecdc4;
            max-height: calc(100vh - 80px);
            overflow-y: auto;
            position: relative;
        }
        .booking-info-modal-close, .booking-create-modal-close {
            color: #aaa; float: right; font-size: 24px; font-weight: bold; cursor: pointer;
        }
        .booking-info-modal-close:hover, .booking-info-modal-close:focus,
        .booking-create-modal-close:hover, .booking-create-modal-close:focus { color: #4ecdc4; }
        .booking-info-modal h3, .booking-create-modal h3 { color: #4ecdc4; margin-top: 0; }
        .booking-info-modal p, .booking-create-modal p { margin: 10px 0; font-size: 1rem; }

        .clear-archive-btn { background: linear-gradient(45deg, #ff6b6b, #ff8e53); color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; margin-left: 10px; }
        .clear-archive-btn:hover { background: linear-gradient(45deg, #ff5252, #ff7b38); }
        .delete-booking-btn { background: #ff6b6b; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .delete-booking-btn:hover { background: #ff5252; }
        .edit-booking-btn { background: #4ecdc4; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-left: 5px; }
        .edit-booking-btn:hover { background: #48bfb3; }
        .confirm-booking-btn { background: #8BC34A; }
        .confirm-booking-btn:hover { background: #7CB342; }
        .btn-secondary { background: #666; }
        .muted { opacity: 0.8; font-size: 0.85rem; }

        /* Interactive seance cards */
        .seance-item {
            position: relative;
            background: rgba(255, 255, 255, 0.06);
            padding: 14px;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: transform .15s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
            border: 1px solid transparent;
            outline: none;
        }
        .seance-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 14px rgba(0,0,0,.25);
        }
        .seance-item:active { transform: translateY(0); box-shadow: 0 3px 8px rgba(0,0,0,.2); }
        .seance-item.selected {
            border-color: #4ecdc4;
            box-shadow: 0 0 0 2px rgba(78,205,196,.35), 0 10px 20px rgba(0,0,0,.25);
            background: linear-gradient(135deg, rgba(78,205,196,.15), rgba(255,255,255,.05));
        }
        .seance-item-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .seance-title { color: #4ecdc4; font-weight: 700; font-size: 1.05rem; display: flex; align-items: center; gap: 8px; }
        .seance-sub { margin-top: 6px; opacity: .9; font-size: .92rem; }
        .chips { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .chip {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 4px 8px; border-radius: 999px; font-size: .78rem; border: 1px solid rgba(255,255,255,.15);
            background: rgba(255,255,255,.06);
        }
        .chip-confirmed { border-color: rgba(139,195,74,.4); background: rgba(139,195,74,.15); color: #b6e47f; }
        .chip-pending { border-color: rgba(255,152,0,.4); background: rgba(255,152,0,.12); color: #ffc36b; }
        .chip-total { border-color: rgba(255,255,255,.25); color: #eaeaea; }
        .seance-cta { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
        .seance-open-btn { background: linear-gradient(45deg, #4ecdc4, #64d8d1); padding: 6px 12px; border-radius: 999px; font-size: .85rem; border: 1px solid rgba(255,255,255,.15); }
        .seance-open-btn:hover { transform: translateY(-1px); }
        .kbd { border: 1px solid rgba(255,255,255,.2); border-bottom-width: 3px; border-radius: 6px; padding: 0 6px; font-size: .74rem; opacity: .85; }
        .fade-in { animation: fadeInUp .25s both; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            body { padding: 10px; } .container { padding: 5px; } h1 { font-size: 1.5rem; }
            .admin-menu { grid-template-columns: 1fr; gap: 10px; }
            .menu-item { padding: 12px; min-height: 70px; } .menu-item h3 { font-size: 1.1rem; }
            .section { padding: 15px; } .form-group { margin-bottom: 12px; }
            input, select, textarea, button { font-size: 0.85rem; padding: 8px; }
            .booking-info-modal-content, .booking-create-modal-content {
                margin: 20px auto; max-height: calc(100vh - 40px);
            }
        }
        @media (max-width: 480px) {
            body { padding: 8px; } h1 { font-size: 1.3rem; }
            .section h2 { font-size: 1.2rem; } .nav-buttons { flex-direction: column; }
            .logout-btn { padding: 6px 12px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <header>
            <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
            <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
        </header>

        <div class="admin-menu">
            <div class="menu-item" onclick="showSection('bookings')">
                <h3>üéüÔ∏è –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
                <p>–ü—Ä–æ—Å–º–æ—Ç—Ä –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –ø–æ —Å–µ–∞–Ω—Å–∞–º</p>
            </div>
            <div class="menu-item" onclick="showSection('movies')">
                <h3>üé¨ –§–∏–ª—å–º—ã</h3>
                <p>–î–æ–±–∞–≤–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</p>
            </div>
            <div class="menu-item" onclick="showSection('seances')">
                <h3>üìÖ –°–µ–∞–Ω—Å—ã</h3>
                <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∞–Ω—Å–∞–º–∏</p>
            </div>
        </div>

        <!-- –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div id="bookings" class="section active">
            <h2>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
            <div class="filters-container">
                <div class="filter-group">
                    <button class="nav-button active" onclick="filterSeancesWithBookings('upcoming')" id="upcomingBtn">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ</button>
                    <button class="nav-button" onclick="filterSeancesWithBookings('today')" id="todayBtn">–°–µ–≥–æ–¥–Ω—è</button>
                    <button class="nav-button" onclick="filterSeancesWithBookings('tomorrow')" id="tomorrowBtn">–ó–∞–≤—Ç—Ä–∞</button>
                    <button class="nav-button" onclick="filterSeancesWithBookings('week')" id="weekBtn">–ù–µ–¥–µ–ª—è</button>
                </div>
                <button class="refresh-btn" onclick="refreshBookingsList()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                <button class="clear-archive-btn" onclick="clearArchive()">–û—á–∏—Å—Ç–∏—Ç—å –∞—Ä—Ö–∏–≤</button>
            </div>
            <div id="bookingsLoading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–∞–Ω—Å–æ–≤ —Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏...</div>
            <div id="seancesWithBookingsContainer" aria-live="polite"></div>
        </div>

        <!-- –§–∏–ª—å–º—ã -->
        <div id="movies" class="section">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å–º–∞–º–∏</h2>
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞:</label>
                <input type="text" id="movieName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞">
            </div>
            <div class="form-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea id="movieDesc" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>–í–æ–∑—Ä–∞—Å—Ç–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:</label>
                <select id="movieAge">
                    <option value="0+">0+</option>
                    <option value="6+" selected>6+</option>
                    <option value="12+">12+</option>
                    <option value="16+">16+</option>
                    <option value="18+">18+</option>
                </select>
            </div>
            <button onclick="addMovie()">–î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å–º</button>
            <div id="movieSuccess" class="success-message">–§–∏–ª—å–º —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!</div>
            <div id="movieError" class="error-message">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!</div>

            <h3 style="margin-top: 25px; text-align: center;">–°–ø–∏—Å–æ–∫ —Ñ–∏–ª—å–º–æ–≤</h3>
            <div id="moviesLoading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª—å–º–æ–≤...</div>
            <div class="table-wrapper">
                <table id="moviesTable" style="display: none;">
                    <thead>
                        <tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–í–æ–∑—Ä–∞—Å—Ç</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
                    </thead>
                    <tbody id="moviesTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- –°–µ–∞–Ω—Å—ã -->
        <div id="seances" class="section">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∞–Ω—Å–∞–º–∏</h2>
            <div class="nav-buttons">
                <button class="nav-button active" onclick="switchSeanceTab('upcoming')">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ</button>
                <button class="nav-button" onclick="switchSeanceTab('archived')">–ê—Ä—Ö–∏–≤</button>
            </div>
            <div id="addSeanceForm">
                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å–º:</label>
                    <select id="seanceMovie">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å–º</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–î–∞—Ç–∞ —Å–µ–∞–Ω—Å–∞:</label>
                    <input type="date" id="seanceDate">
                </div>
                <div class="form-group">
                    <label>–í—Ä–µ–º—è —Å–µ–∞–Ω—Å–∞:</label>
                    <input type="time" id="seanceTime">
                </div>
                <button onclick="addSeance()">–î–æ–±–∞–≤–∏—Ç—å —Å–µ–∞–Ω—Å</button>
                <div id="seanceSuccess" class="success-message">–°–µ–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!</div>
                <div id="seanceError" class="error-message">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!</div>
            </div>
            <h3 id="seancesListTitle" style="margin-top: 25px; text-align: center;">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–µ–∞–Ω—Å—ã</h3>
            <div id="seancesLoading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–∞–Ω—Å–æ–≤...</div>
            <div class="table-wrapper">
                <table id="seancesTable" style="display: none;">
                    <thead>
                        <tr><th>–§–∏–ª—å–º</th><th>–î–∞—Ç–∞</th><th>–í—Ä–µ–º—è</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
                    </thead>
                    <tbody id="seancesTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª–∫–∏ -->
        <div id="editMovieModal" class="hall-modal">
            <div class="hall-modal-content" style="max-width: 500px;">
                <span class="hall-modal-close" onclick="closeEditMovieModal()">&times;</span>
                <h2 style="color: #4ecdc4;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–ª—å–º</h2>
                <input type="hidden" id="editMovieId">
                <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label><input type="text" id="editMovieName"></div>
                <div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ:</label><textarea id="editMovieDesc" rows="3"></textarea></div>
                <div class="form-group">
                    <label>–í–æ–∑—Ä–∞—Å—Ç:</label>
                    <select id="editMovieAge">
                        <option value="0+">0+</option><option value="6+">6+</option><option value="12+">12+</option><option value="16+">16+</option><option value="18+">18+</option>
                    </select>
                </div>
                <button onclick="saveMovieChanges()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button onclick="closeEditMovieModal()" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>

        <div id="hallSchemeModal" class="hall-modal">
            <div class="hall-modal-content">
                <span class="hall-modal-close" onclick="closeHallSchemeModal()">&times;</span>
                <div class="hall-modal-header">
                    <h2>–°—Ö–µ–º–∞ –∑–∞–ª–∞</h2>
                    <p id="hallModalInfo"></p>
                </div>
                <div id="hallSchemeContainer"></div>
                <h3 style="margin: 20px 0; color: #4ecdc4;">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
                <div id="bookingsTableContainer" class="table-wrapper"></div>
            </div>
        </div>

        <div id="bookingInfoModal" class="booking-info-modal">
            <div class="booking-info-modal-content">
                <span class="booking-info-modal-close" onclick="closeBookingInfoModal()">&times;</span>
                <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏</h3>
                <div id="bookingInfoContent"></div>
            </div>
        </div>

        <div id="bookingCreateModal" class="booking-create-modal">
            <div class="booking-create-modal-content">
                <span class="booking-create-modal-close" onclick="closeBookingCreateModal()">&times;</span>
                <h3>–°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                <div id="bookingCreateContent">
                    <input type="hidden" id="createBookingFilm">
                    <input type="hidden" id="createBookingDate">
                    <input type="hidden" id="createBookingTime">
                    <input type="hidden" id="createBookingSeat">
                    <div class="form-group"><label>–ú–µ—Å—Ç–æ:</label><p id="createBookingSeatDisplay"></p></div>
                    <div class="form-group"><label>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞:</label><input type="text" id="createBookingCustomerName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è"></div>
                    <div class="form-group"><label>–¢–µ–ª–µ—Ñ–æ–Ω:</label><input type="tel" id="createBookingCustomerPhone" placeholder="+7XXXXXXXXXX"></div>
                    <div class="form-group">
                        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫:</label>
                        <input type="number" id="createBookingPeople" min="1" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                        <div class="muted" id="createPeopleHint"></div>
                    </div>
                    <div class="form-group"><label>–¶–µ–Ω–∞ (—Ä—É–±.):</label><input type="number" id="createBookingPrice" min="0" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É"></div>
                    <button onclick="createBooking()">–°–æ–∑–¥–∞—Ç—å</button>
                    <button onclick="closeBookingCreateModal()" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                    <div id="createBookingSuccess" class="success-message">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!</div>
                    <div id="createBookingError" class="error-message">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!</div>
                </div>
            </div>
        </div>

        <div id="bookingEditModal" class="booking-create-modal">
            <div class="booking-create-modal-content">
                <span class="booking-create-modal-close" onclick="closeBookingEditModal()">&times;</span>
                <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                <div id="bookingEditContent">
                    <input type="hidden" id="editBookingId">
                    <input type="hidden" id="editBookingFilm">
                    <input type="hidden" id="editBookingDate">
                    <input type="hidden" id="editBookingTime">
                    <input type="hidden" id="editBookingOriginalSeat">
                    <div class="form-group">
                        <label>–ú–µ—Å—Ç–æ (—Ä—è–¥-‚Ññ):</label>
                        <input type="text" id="editBookingSeat" placeholder="–ù–∞–ø—Ä., 3-2">
                        <p class="muted" style="margin-top:6px;">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –º–µ—Å—Ç—É –Ω–∞ —Å—Ö–µ–º–µ ‚Üí ¬´–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è¬ª ‚Üí ¬´–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å¬ª.</p>
                    </div>
                    <div class="form-group"><label>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞:</label><input type="text" id="editBookingCustomerName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è"></div>
                    <div class="form-group"><label>–¢–µ–ª–µ—Ñ–æ–Ω:</label><input type="tel" id="editBookingCustomerPhone" placeholder="+7XXXXXXXXXX"></div>
                    <div class="form-group">
                        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫:</label>
                        <input type="number" id="editBookingPeople" min="1" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                        <div class="muted" id="editPeopleHint"></div>
                    </div>
                    <div class="form-group"><label>–¶–µ–Ω–∞ (—Ä—É–±.):</label><input type="number" id="editBookingPrice" min="0" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É"></div>
                    <button onclick="updateBooking()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button onclick="closeBookingEditModal()" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                    <div id="editBookingSuccess" class="success-message">–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</div>
                    <div id="editBookingError" class="error-message">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase init (guard)
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDeX86T2r1K0LRMEyk3UdUF68bfYiTwjiw",
            authDomain: "lvgkino.firebaseapp.com",
            projectId: "lvgkino",
            storageBucket: "lvgkino.firebasestorage.app",
            messagingSenderId: "526810546839",
            appId: "1:526810546839:web:aaf02cb3a91b31cd311fd2"
        };
        if (!window.adminPanelInitialized) {
            window.adminPanelInitialized = true;

            const MESSAGE_TIMEOUT = 5000;
            const ERROR_MESSAGES = {
                FIREBASE_INIT_FAILED: '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase: ',
                FIRESTORE_UNAVAILABLE: 'Firestore –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω.',
                INVALID_INPUT: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.',
                MOVIE_ADD_FAILED: '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å–º–∞: ',
                MOVIE_DELETE_FAILED: '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∏–ª—å–º–∞: ',
                MOVIE_UPDATE_FAILED: '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å–º–∞: ',
                SEANCE_ADD_FAILED: '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ–∞–Ω—Å–∞: ',
                SEANCE_DELETE_FAILED: '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–µ–∞–Ω—Å–∞: ',
                SEANCE_DUPLICATE: '–°–µ–∞–Ω—Å –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∏–ª—å–º–∞, –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.',
                BOOKING_DELETE_FAILED: '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ',
                BOOKING_CREATE_FAILED: '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ',
                BOOKING_UPDATE_FAILED: '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ',
                BOOKING_CONFIRM_FAILED: '–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: '
            };

            let db = null;
            try {
                if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
                db = firebase.firestore();
                try { firebase.firestore().enablePersistence({ synchronizeTabs: true }); } catch (e) {}
            } catch (error) {
                alert(ERROR_MESSAGES.FIREBASE_INIT_FAILED + error.message);
            }

            // Globals
            let currentBookingFilter = 'upcoming';
            let currentSeanceTab = 'upcoming';
            let allSeances = [];
            let currentHighlightedBookingId = null;
            let currentSeanceDetails = { film: '', date: '', time: '' };
            let selectedSeanceKey = null;

            // Live subscriptions
            let moviesUnsub = null;
            let seancesUnsub = null;
            let bookingsListUnsub = null;
            let hallBookingsUnsub = null;
            let todayAutoCancelUnsub = null;

            // Auto-cancel cache/timer
            let cachedTodayBookings = [];
            let autoCancelIntervalId = null;

            // Cache
            let currentMovies = [];

            // Utils
            function formatDate(date) {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            }
            function getTodayStr() { const t = new Date(); t.setHours(0,0,0,0); return formatDate(t); }
            function getTomorrowStr() { const t = new Date(); t.setHours(0,0,0,0); t.setDate(t.getDate() + 1); return formatDate(t); }
            function getNextWeekStr() { const t = new Date(); t.setHours(0,0,0,0); t.setDate(t.getDate() + 7); return formatDate(t); }
            function getNowTimeHHMM() { const n = new Date(); return `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; }
            function parseLocalDateTime(dateStr, timeStr) {
                const [y,m,d] = dateStr.split('-').map(Number);
                const [hh,mm] = timeStr.split(':').map(Number);
                return new Date(y, m - 1, d, hh, mm, 0, 0);
            }

            // Seat layout helpers
            function getHallLayout() {
                return [
                    { row: 1, seats: 8, type: 'single' },
                    { row: 2, seats: 5, type: 'double' },
                    { row: 3, seats: 6, type: 'double' },
                    { row: 4, seats: 6, type: 'double' },
                    { row: 5, seats: 6, type: 'mixed', details: ['quad','double','double','double','double','quad'] },
                    { row: 6, seats: 5, type: 'mixed', details: ['quad','double','double','double','quad'] }
                ];
            }
            function getSeatTypeFromId(seatId) {
                if (!seatId || typeof seatId !== 'string' || !seatId.includes('-')) return null;
                const [rowStr, colStr] = seatId.split('-');
                const r = parseInt(rowStr, 10) - 1;
                const c = parseInt(colStr, 10) - 1;
                const layout = getHallLayout();
                const row = layout[r];
                if (!row) return null;
                if (row.type === 'single') return 'single';
                if (row.type === 'double') return 'double';
                if (row.type === 'mixed') return row.details[c] || null;
                return null;
            }
            function getPeopleRangeForSeatType(type) {
                if (type === 'single') return { min: 1, max: 1 };
                if (type === 'double') return { min: 2, max: 3 };
                if (type === 'quad') return { min: 4, max: 6 };
                return { min: 1, max: 6 };
            }
            function applyPeopleRangeForCreate(seatId) {
                const type = getSeatTypeFromId(seatId);
                const { min, max } = getPeopleRangeForSeatType(type);
                const input = document.getElementById('createBookingPeople');
                const hint = document.getElementById('createPeopleHint');
                input.min = String(min);
                input.max = String(max);
                hint.textContent = `–î–æ–ø—É—Å—Ç–∏–º–æ: ${min}‚Äì${max}`;
                const val = parseInt(input.value || '0', 10);
                if (!val || val < min) input.value = String(min);
                if (val > max) input.value = String(max);
            }
            function applyPeopleRangeForEdit(seatId) {
                const type = getSeatTypeFromId(seatId);
                const { min, max } = getPeopleRangeForSeatType(type);
                const input = document.getElementById('editBookingPeople');
                const hint = document.getElementById('editPeopleHint');
                input.min = String(min);
                input.max = String(max);
                hint.textContent = `–î–æ–ø—É—Å—Ç–∏–º–æ: ${min}‚Äì${max}`;
                const val = parseInt(input.value || '0', 10);
                if (!val || val < min) input.value = String(min);
                if (val > max) input.value = String(max);
            }

            window.onload = function() {
                if (localStorage.getItem('adminLoggedIn') !== 'true') { window.location.href = 'admin.html'; return; }
                if (!db) { alert(ERROR_MESSAGES.FIRESTORE_UNAVAILABLE); return; }
                const today = new Date().toISOString().split('T')[0];
                const seanceDateInput = document.getElementById('seanceDate');
                if (seanceDateInput) seanceDateInput.value = today;

                subscribeToMovies();
                switchSeanceTab('upcoming');
                subscribeToBookingsList(currentBookingFilter);
                startAutoCancelWatcher();
            };

            // Navigation
            window.logout = function() { localStorage.removeItem('adminLoggedIn'); window.location.href = 'admin.html'; };

            window.showSection = function(sectionId) {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                const section = document.getElementById(sectionId);
                if (section) section.classList.add('active');
                if (sectionId === 'movies') subscribeToMovies();
                else if (sectionId === 'seances') switchSeanceTab(currentSeanceTab);
                else if (sectionId === 'bookings') subscribeToBookingsList(currentBookingFilter);
            };

            // Movies CRUD
            window.addMovie = async function() {
                const name = document.getElementById('movieName').value.trim();
                const desc = document.getElementById('movieDesc').value.trim();
                const age = document.getElementById('movieAge').value;
                const success = document.getElementById('movieSuccess');
                const error = document.getElementById('movieError');
                success.style.display = 'none'; error.style.display = 'none';
                if (!name || !desc || !age) {
                    error.textContent = ERROR_MESSAGES.INVALID_INPUT; error.style.display = 'block';
                    setTimeout(() => error.style.display = 'none', MESSAGE_TIMEOUT); return;
                }
                try {
                    await db.collection('movies').add({
                        name, description: desc, age,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    success.style.display = 'block';
                    setTimeout(() => success.style.display = 'none', MESSAGE_TIMEOUT);
                    document.getElementById('movieName').value = '';
                    document.getElementById('movieDesc').value = '';
                } catch (e) {
                    error.textContent = ERROR_MESSAGES.MOVIE_ADD_FAILED + e.message;
                    error.style.display = 'block';
                    setTimeout(() => error.style.display = 'none', MESSAGE_TIMEOUT);
                }
            };

            window.editMovie = function(movieId) {
                db.collection('movies').doc(movieId).get().then(doc => {
                    if (!doc.exists) return;
                    const data = doc.data();
                    document.getElementById('editMovieId').value = movieId;
                    document.getElementById('editMovieName').value = data.name;
                    document.getElementById('editMovieDesc').value = data.description;
                    document.getElementById('editMovieAge').value = data.age;
                    document.getElementById('editMovieModal').style.display = 'block';
                }).catch(e => alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å–º–∞: ' + e.message));
            };
            window.closeEditMovieModal = function() { document.getElementById('editMovieModal').style.display = 'none'; };
            window.saveMovieChanges = async function() {
                const id = document.getElementById('editMovieId').value;
                const name = document.getElementById('editMovieName').value.trim();
                const desc = document.getElementById('editMovieDesc').value.trim();
                const age = document.getElementById('editMovieAge').value;
                if (!name || !desc || !age) { alert(ERROR_MESSAGES.INVALID_INPUT); return; }
                try { await db.collection('movies').doc(id).update({ name, description: desc, age }); closeEditMovieModal(); alert('–§–∏–ª—å–º –æ–±–Ω–æ–≤–ª—ë–Ω!'); }
                catch (e) { alert(ERROR_MESSAGES.MOVIE_UPDATE_FAILED + e.message); }
            };
            window.deleteMovie = async function(movieId) {
                if (confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∏–ª—å–º?')) {
                    try { await db.collection('movies').doc(movieId).delete(); alert('–§–∏–ª—å–º —É–¥–∞–ª—ë–Ω!'); }
                    catch (e) { alert(ERROR_MESSAGES.MOVIE_DELETE_FAILED + e.message); }
                }
            };

            function subscribeToMovies() {
                const loading = document.getElementById('moviesLoading');
                const table = document.getElementById('moviesTable');
                const tbody = document.getElementById('moviesTableBody');
                if (loading) loading.style.display = 'block';
                if (table) table.style.display = 'none';
                if (typeof moviesUnsub === 'function') moviesUnsub();

                moviesUnsub = db.collection('movies').orderBy('name').onSnapshot(snapshot => {
                    currentMovies = [];
                    tbody.innerHTML = '';
                    if (snapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">–ù–µ—Ç —Ñ–∏–ª—å–º–æ–≤</td></tr>';
                    } else {
                        snapshot.forEach(doc => {
                            const m = { id: doc.id, ...doc.data() };
                            currentMovies.push(m);
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${m.name}</td>
                                <td>${m.description}</td>
                                <td>${m.age}</td>
                                <td>
                                    <button class="edit-booking-btn" onclick="editMovie('${m.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                    <button class="delete-booking-btn" onclick="deleteMovie('${m.id}')">–£–¥–∞–ª–∏—Ç—å</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                    if (loading) loading.style.display = 'none';
                    if (table) table.style.display = 'table';
                    updateSeanceSelectFromCache();
                }, (e) => { if (loading) loading.innerHTML = `–û—à–∏–±–∫–∞: ${e.message}`; });
            }

            function updateSeanceSelectFromCache() {
                const select = document.getElementById('seanceMovie');
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å–º</option>';
                currentMovies.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.name;
                    opt.textContent = m.name;
                    select.appendChild(opt);
                });
                if (currentValue && [...select.options].some(o => o.value === currentValue)) select.value = currentValue;
            }

            // Seances
            window.switchSeanceTab = function(tab) {
                document.querySelectorAll('#seances .nav-button').forEach(b => b.classList.remove('active'));
                if (tab === 'upcoming') {
                    document.querySelector('button[onclick="switchSeanceTab(\'upcoming\')"]').classList.add('active');
                    document.getElementById('addSeanceForm').style.display = 'block';
                    document.getElementById('seancesListTitle').textContent = '–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–µ–∞–Ω—Å—ã';
                } else {
                    document.querySelector('button[onclick="switchSeanceTab(\'archived\')"]').classList.add('active');
                    document.getElementById('addSeanceForm').style.display = 'none';
                    document.getElementById('seancesListTitle').textContent = '–ê—Ä—Ö–∏–≤ —Å–µ–∞–Ω—Å–æ–≤';
                }
                currentSeanceTab = tab;
                subscribeToSeances(tab);
            };

            window.addSeance = async function() {
                const movie = document.getElementById('seanceMovie').value;
                const date = document.getElementById('seanceDate').value;
                const time = document.getElementById('seanceTime').value;
                const success = document.getElementById('seanceSuccess');
                const error = document.getElementById('seanceError');
                success.style.display = 'none'; error.style.display = 'none';

                if (!movie || !date || !time) {
                    error.textContent = ERROR_MESSAGES.INVALID_INPUT; error.style.display = 'block';
                    setTimeout(() => error.style.display = 'none', MESSAGE_TIMEOUT); return;
                }
                const [y, m, d] = date.split('-').map(Number);
                const seanceDate = new Date(y, m - 1, d);
                const today = new Date(); today.setHours(0,0,0,0);
                if (seanceDate < today) {
                    error.textContent = '–î–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º'; error.style.display = 'block';
                    setTimeout(() => error.style.display = 'none', MESSAGE_TIMEOUT); return;
                }
                if (seanceExists(movie, date, time)) {
                    error.textContent = ERROR_MESSAGES.SEANCE_DUPLICATE; error.style.display = 'block';
                    setTimeout(() => error.style.display = 'none', MESSAGE_TIMEOUT); return;
                }
                try {
                    await db.collection('seances').add({ movie, date, time });
                    success.style.display = 'block';
                    setTimeout(() => success.style.display = 'none', MESSAGE_TIMEOUT);
                    document.getElementById('seanceTime').value = '';
                    switchSeanceTab(currentSeanceTab);
                } catch (e) {
                    error.textContent = ERROR_MESSAGES.SEANCE_ADD_FAILED + e.message;
                    error.style.display = 'block';
                    setTimeout(() => error.style.display = 'none', MESSAGE_TIMEOUT);
                }
            };

            // Cascade delete: seance + related bookings
            window.deleteSeance = async function(id) {
                if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–µ–∞–Ω—Å –∏ –≤—Å–µ –µ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è?')) return;
                try {
                    const seanceDoc = await db.collection('seances').doc(id).get();
                    let movie = null, date = null, time = null;
                    if (seanceDoc.exists) {
                        const s = seanceDoc.data();
                        movie = s.movie; date = s.date; time = s.time;
                    }
                    if (movie && date && time) {
                        let totalDeleted = 0;
                        // eslint-disable-next-line no-constant-condition
                        while (true) {
                            const snap = await db.collection('bookings')
                                .where('film', '==', movie)
                                .where('date', '==', date)
                                .where('time', '==', time)
                                .limit(500).get();
                            if (snap.empty) break;
                            const batch = db.batch();
                            snap.docs.forEach(d => batch.delete(db.collection('bookings').doc(d.id)));
                            await batch.commit();
                            totalDeleted += snap.docs.length;
                            if (snap.size < 500) break;
                        }
                        console.log('–£–¥–∞–ª–µ–Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –¥–ª—è —Å–µ–∞–Ω—Å–∞:', totalDeleted);
                    }
                    await db.collection('seances').doc(id).delete();
                    alert('–°–µ–∞–Ω—Å –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω—ã!');
                } catch (e) {
                    alert(ERROR_MESSAGES.SEANCE_DELETE_FAILED + e.message);
                }
            };

            function seanceExists(film, date, time) {
                const today = new Date(); today.setHours(0,0,0,0);
                const [y, m, d] = date.split('-').map(Number);
                const seanceDate = new Date(y, m - 1, d);
                return allSeances.some(s => s.movie === film && s.date === date && s.time === time && seanceDate >= today);
            }

            function subscribeToSeances(tab) {
                const loading = document.getElementById('seancesLoading');
                const table = document.getElementById('seancesTable');
                const tbody = document.getElementById('seancesTableBody');
                if (loading) loading.style.display = 'block';
                if (table) table.style.display = 'none';
                if (typeof seancesUnsub === 'function') seancesUnsub();

                const todayStr = getTodayStr();
                let query = db.collection('seances');
                if (tab === 'upcoming') query = query.where('date', '>=', todayStr);
                else if (tab === 'archived') query = query.where('date', '<', todayStr);
                query = query.orderBy('date'); // –±–µ–∑ –∏–Ω–¥–µ–∫—Å–∞ –ø–æ time

                seancesUnsub = query.onSnapshot(snapshot => {
                    let seances = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).filter(s => s.movie && s.date && s.time);
                    seances.sort((a, b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time));
                    tbody.innerHTML = seances.length
                        ? seances.map(s => `
                            <tr>
                                <td>${s.movie}</td>
                                <td>${s.date}</td>
                                <td>${s.time}</td>
                                <td><button class="delete-booking-btn" onclick="deleteSeance('${s.id}')">–£–¥–∞–ª–∏—Ç—å</button></td>
                            </tr>
                        `).join('')
                        : '<tr><td colspan="4" style="text-align: center;">–ù–µ—Ç —Å–µ–∞–Ω—Å–æ–≤</td></tr>';
                    if (loading) loading.style.display = 'none';
                    if (table) table.style.display = 'table';
                    allSeances = seances;
                }, (e) => { if (loading) loading.innerHTML = `–û—à–∏–±–∫–∞: ${e.message}`; });
            }

            // Bookings list (grouped) with interactive cards
            window.filterSeancesWithBookings = function(filter) {
                document.querySelectorAll('#bookings .nav-button').forEach(b => b.classList.remove('active'));
                document.getElementById(filter + 'Btn')?.classList.add('active');
                currentBookingFilter = filter;
                subscribeToBookingsList(filter);
            };
            window.refreshBookingsList = function() { subscribeToBookingsList(currentBookingFilter, true); };

            function subscribeToBookingsList(filter = 'upcoming') {
                const loading = document.getElementById('bookingsLoading');
                const container = document.getElementById('seancesWithBookingsContainer');
                if (loading) loading.style.display = 'block';
                if (container) container.innerHTML = '';
                if (typeof bookingsListUnsub === 'function') bookingsListUnsub();

                const todayStr = getTodayStr();
                const tomorrowStr = getTomorrowStr();
                const nextWeekStr = getNextWeekStr();

                let query = db.collection('bookings').where('date', '>=', todayStr);

                bookingsListUnsub = query.onSnapshot(snapshot => {
                    const bookings = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    const groups = {};
                    bookings.forEach(b => {
                        const key = `${b.film}_${b.date}_${b.time}`;
                        if (!groups[key]) groups[key] = { key, film: b.film, date: b.date, time: b.time, bookings: [] };
                        groups[key].bookings.push(b);
                    });
                    let list = Object.values(groups);

                    if (filter === 'today') list = list.filter(s => s.date === todayStr);
                    else if (filter === 'tomorrow') list = list.filter(s => s.date === tomorrowStr);
                    else if (filter === 'week') list = list.filter(s => s.date >= todayStr && s.date <= nextWeekStr);

                    list.sort((a, b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time));

                    container.innerHTML = list.length ? list.map(s => {
                        const total = s.bookings.length;
                        const confirmed = s.bookings.filter(b => b.confirmed === true).length;
                        const pending = total - confirmed;
                        const isSelected = selectedSeanceKey === s.key ? 'selected' : '';
                        return `
                        <div class="seance-item fade-in ${isSelected}" role="button" tabindex="0"
                             data-key="${s.key}"
                             onmousedown="selectSeanceCard('${s.key}')"
                             onclick="selectSeanceCard('${s.key}'); showHallScheme('${s.film}', '${s.date}', '${s.time}')"
                             onkeydown="if(event.key==='Enter'||event.key===' '){selectSeanceCard('${s.key}'); showHallScheme('${s.film}','${s.date}','${s.time}')}">
                            <div class="seance-item-header">
                                <div class="seance-title">üé¨ ${s.film}</div>
                                <div class="chips">
                                    <span class="chip chip-confirmed" title="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ">‚úî ${confirmed}</span>
                                    <span class="chip chip-pending" title="–û–∂–∏–¥–∞—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è">‚è≥ ${pending}</span>
                                    <span class="chip chip-total" title="–í—Å–µ–≥–æ">${total}</span>
                                </div>
                            </div>
                            <div class="seance-sub">üìÖ ${s.date} &nbsp; ‚Ä¢ &nbsp; ‚è∞ ${s.time}</div>
                            <div class="seance-cta">
                                <button class="seance-open-btn">–û—Ç–∫—Ä—ã—Ç—å –∑–∞–ª <span class="kbd">Enter</span></button>
                            </div>
                        </div>`;
                    }).join('') : '<p style="text-align: center; color: #ff6b6b;">–ù–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Å–µ–∞–Ω—Å–æ–≤ —Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏</p>';

                    if (selectedSeanceKey) {
                        const el = container.querySelector(`.seance-item[data-key="${selectedSeanceKey}"]`);
                        if (el) el.classList.add('selected');
                    }

                    if (loading) loading.style.display = 'none';
                }, (e) => { if (loading) loading.innerHTML = `–û—à–∏–±–∫–∞: ${e.message}`; });
            }

            window.selectSeanceCard = function(key) {
                selectedSeanceKey = key;
                document.querySelectorAll('#seancesWithBookingsContainer .seance-item').forEach(el => el.classList.remove('selected'));
                const el = document.querySelector(`#seancesWithBookingsContainer .seance-item[data-key="${key}"]`);
                if (el) el.classList.add('selected');
            };

            // Hall
            window.showHallScheme = function(film, date, time) {
                currentSeanceDetails = { film, date, time };
                const modal = document.getElementById('hallSchemeModal');
                const container = document.getElementById('hallSchemeContainer');
                const info = document.getElementById('hallModalInfo');
                const tableContainer = document.getElementById('bookingsTableContainer');
                if (!modal || !container || !info || !tableContainer) return;
                container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
                tableContainer.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
                info.textContent = `–§–∏–ª—å–º: ${film} | –î–∞—Ç–∞: ${date} | –í—Ä–µ–º—è: ${time}`;
                modal.style.display = 'block';
                subscribeToHallBookings(film, date, time);
            };

            function subscribeToHallBookings(film, date, time) {
                const container = document.getElementById('hallSchemeContainer');
                const tableContainer = document.getElementById('bookingsTableContainer');
                if (typeof hallBookingsUnsub === 'function') hallBookingsUnsub();

                const query = db.collection('bookings')
                    .where('film', '==', film)
                    .where('date', '==', date)
                    .where('time', '==', time);

                hallBookingsUnsub = query.onSnapshot(snapshot => {
                    const fetched = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderHallWithBookings(container, tableContainer, fetched);
                    autoCancelExpiredBookings(fetched); // safeguard within seance
                }, (e) => {
                    container.innerHTML = `<p style="color: #ff6b6b;">–û—à–∏–±–∫–∞: ${e.message}</p>`;
                    tableContainer.innerHTML = `<p style="color: #ff6b6b;">–û—à–∏–±–∫–∞: ${e.message}</p>`;
                });
            }

            function renderHallWithBookings(container, tableContainer, bookings) {
                const layout = getHallLayout();
                let hallHTML = `<div class="hall-modal-screen">–≠–ö–†–ê–ù</div>`;
                layout.forEach(r => {
                    hallHTML += `<div class="hall-modal-row"><div class="hall-modal-row-label">${r.row}</div>`;
                    const makeSeat = (id, label) => {
                        const b = bookings.find(b => b.seat === id);
                        if (b) {
                            const statusClass = b.confirmed === true ? 'confirmed' : 'pending';
                            const onclick = `showBookingInfo(this)`;
                            return `<div class="hall-modal-seat hall-modal-${label} booked ${statusClass}" data-seat="${id}" data-booking-id="${b.id}" onclick="${onclick}" title="${b.confirmed === true ? '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ' : '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è'}">${id}</div>`;
                        } else {
                            return `<div class="hall-modal-seat hall-modal-${label} available" data-seat="${id}" onclick="showBookingCreateForm('${id}')" title="–°–≤–æ–±–æ–¥–Ω–æ">${id}</div>`;
                        }
                    };
                    if (r.type === 'single') {
                        for (let i = 1; i <= r.seats; i++) hallHTML += makeSeat(`${r.row}-${i}`, 'single');
                    } else if (r.type === 'double' || r.type === 'mixed') {
                        (r.type === 'mixed' ? r.details : Array(r.seats).fill('double'))
                            .forEach((t, i) => hallHTML += makeSeat(`${r.row}-${i+1}`, t));
                    }
                    hallHTML += `</div>`;
                });
                container.innerHTML = hallHTML;

                // Table
                tableContainer.innerHTML = `
                    <table>
                        <thead><tr>
                            <th>–ú–µ—Å—Ç–æ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ß–µ–ª.</th><th>–¶–µ–Ω–∞</th><th>–ò–º—è</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr></thead>
                        <tbody id="bookingsTableBody"></tbody>
                    </table>
                `;
                const tbody = document.getElementById('bookingsTableBody');
                bookings.sort((a,b) => (a.seat||'').localeCompare(b.seat||''));
                tbody.innerHTML = bookings.length ? bookings.map(b => {
                    const statusText = b.confirmed === true ? '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ' : '–û–∂–∏–¥–∞–µ—Ç';
                    const confirmBtn = b.confirmed === true ? '' : `<button class="edit-booking-btn confirm-booking-btn" onclick="confirmBookingAdmin('${b.id}');event.stopPropagation()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>`;
                    return `
                        <tr id="booking-${b.id}" style="cursor:pointer" onclick="highlightSeat('${b.id}', '${b.seat}')">
                            <td>${b.seat || '---'}</td>
                            <td>${statusText}</td>
                            <td>${b.people || '---'}</td>
                            <td>${b.price || 0} —Ä—É–±.</td>
                            <td>${b.customerName || '---'}</td>
                            <td>${b.customerPhone || '---'}</td>
                            <td>
                                ${confirmBtn}
                                <button class="edit-booking-btn" onclick="showBookingEditForm('${b.id}');event.stopPropagation()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                <button class="delete-booking-btn" onclick="deleteBooking('${b.id}');event.stopPropagation()">–£–¥–∞–ª–∏—Ç—å</button>
                            </td>
                        </tr>
                    `;
                }).join('') : '<tr><td colspan="7" style="text-align: center;">–ù–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</td></tr>';

                if (currentHighlightedBookingId) {
                    const selected = bookings.find(b => b.id === currentHighlightedBookingId);
                    if (selected) {
                        const el = document.querySelector(`.hall-modal-seat[data-seat="${selected.seat}"]`);
                        if (el) el.classList.add('highlighted');
                    } else {
                        currentHighlightedBookingId = null;
                    }
                }
            }

            // Booking info / actions
            window.showBookingInfo = async function(seatEl) {
                const id = seatEl.dataset.bookingId;
                const modal = document.getElementById('bookingInfoModal');
                const content = document.getElementById('bookingInfoContent');
                if (!modal || !content) return;
                try {
                    const doc = await db.collection('bookings').doc(id).get();
                    if (!doc.exists) {
                        content.innerHTML = '<p>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                    } else {
                        const b = doc.data();
                        const ts = b.bookingTimestamp?.toDate ? b.bookingTimestamp.toDate().toLocaleString('ru-RU') : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                        const statusText = b.confirmed === true ? '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ' : '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è';
                        const confirmBtn = b.confirmed === true
                            ? ''
                            : `<button class="edit-booking-btn confirm-booking-btn" style="margin-right:8px" onclick="confirmBookingAdmin('${id}');closeBookingInfoModal()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>`;
                        content.innerHTML = `
                            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${statusText}</p>
                            <p><strong>–§–∏–ª—å–º:</strong> ${b.film}</p>
                            <p><strong>–î–∞—Ç–∞:</strong> ${b.date} ${b.time}</p>
                            <p><strong>–ú–µ—Å—Ç–æ:</strong> ${b.seat}</p>
                            <p><strong>–ß–µ–ª–æ–≤–µ–∫:</strong> ${b.people}</p>
                            <p><strong>–¶–µ–Ω–∞:</strong> ${b.price} —Ä—É–±.</p>
                            <p><strong>–ò–º—è:</strong> ${b.customerName}</p>
                            <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${b.customerPhone}</p>
                            <p><strong>–ë—Ä–æ–Ω—å —Å–æ–∑–¥–∞–Ω–∞:</strong> ${ts}</p>
                            <div style="margin-top:15px">
                                ${confirmBtn}
                                <button class="edit-booking-btn" onclick="showBookingEditForm('${id}');closeBookingInfoModal()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                <button class="delete-booking-btn" onclick="deleteBooking('${id}');closeBookingInfoModal()">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        `;
                    }
                    modal.style.display = 'block';
                } catch (e) {
                    content.innerHTML = `<p>–û—à–∏–±–∫–∞: ${e.message}</p>`;
                    modal.style.display = 'block';
                }
            };

            window.confirmBookingAdmin = async function(id) {
                try {
                    await db.collection('bookings').doc(id).update({
                        confirmed: true,
                        confirmedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (e) {
                    alert(ERROR_MESSAGES.BOOKING_CONFIRM_FAILED + e.message);
                }
            };

            window.deleteBooking = async function(id) {
                if (confirm('–£–¥–∞–ª–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?')) {
                    try { await db.collection('bookings').doc(id).delete(); alert('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ!'); }
                    catch (e) { alert(ERROR_MESSAGES.BOOKING_DELETE_FAILED + e.message); }
                }
            };

            window.closeBookingInfoModal = function() { document.getElementById('bookingInfoModal').style.display = 'none'; };

            // Create / Edit booking
            window.showBookingCreateForm = function(seat) {
                const modal = document.getElementById('bookingCreateModal');
                if (!modal) return;
                document.getElementById('createBookingFilm').value = currentSeanceDetails.film;
                document.getElementById('createBookingDate').value = currentSeanceDetails.date;
                document.getElementById('createBookingTime').value = currentSeanceDetails.time;
                document.getElementById('createBookingSeat').value = seat;
                document.getElementById('createBookingSeatDisplay').textContent = seat;
                document.getElementById('createBookingCustomerName').value = '';
                document.getElementById('createBookingCustomerPhone').value = '';
                document.getElementById('createBookingPeople').value = '';
                document.getElementById('createBookingPrice').value = '';
                document.getElementById('createBookingSuccess').style.display = 'none';
                document.getElementById('createBookingError').style.display = 'none';
                applyPeopleRangeForCreate(seat);
                modal.style.display = 'block';
            };

            window.createBooking = async function() {
                const film = document.getElementById('createBookingFilm').value;
                const date = document.getElementById('createBookingDate').value;
                const time = document.getElementById('createBookingTime').value;
                const seat = document.getElementById('createBookingSeat').value;
                const customerName = document.getElementById('createBookingCustomerName').value.trim();
                const customerPhone = document.getElementById('createBookingCustomerPhone').value.trim();
                const people = parseInt(document.getElementById('createBookingPeople').value);
                const price = parseInt(document.getElementById('createBookingPrice').value);
                const success = document.getElementById('createBookingSuccess');
                const error = document.getElementById('createBookingError');
                success.style.display = 'none'; error.style.display = 'none';

                if (!film || !date || !time || !seat || !customerName || !customerPhone || !people || !price) {
                    error.textContent = ERROR_MESSAGES.INVALID_INPUT; error.style.display = 'block';
                    setTimeout(() => error.style.display = 'none', MESSAGE_TIMEOUT); return;
                }
                const type = getSeatTypeFromId(seat);
                const { min, max } = getPeopleRangeForSeatType(type);
                if (people < min || people > max) {
                    error.textContent = `–î–ª—è —ç—Ç–æ–≥–æ –º–µ—Å—Ç–∞ –¥–æ–ø—É—Å—Ç–∏–º–æ –æ—Ç ${min} –¥–æ ${max} —á–µ–ª–æ–≤–µ–∫.`; error.style.display = 'block';
                    setTimeout(() => error.style.display = 'none', MESSAGE_TIMEOUT); return;
                }
                try {
                    const snapshot = await db.collection('bookings')
                        .where('film', '==', film).where('date', '==', date).where('time', '==', time).where('seat', '==', seat).limit(1).get();
                    if (!snapshot.empty) {
                        error.textContent = '–ú–µ—Å—Ç–æ —É–∂–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ!'; error.style.display = 'block';
                        setTimeout(() => error.style.display = 'none', MESSAGE_TIMEOUT); return;
                    }
                    await db.collection('bookings').add({
                        film, date, time, seat,
                        customerName, customerPhone, people, price,
                        confirmed: true,
                        confirmedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        bookingTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    success.style.display = 'block';
                    setTimeout(() => success.style.display = 'none', MESSAGE_TIMEOUT);
                    closeBookingCreateModal();
                } catch (e) {
                    error.textContent = ERROR_MESSAGES.BOOKING_CREATE_FAILED + e.message;
                    error.style.display = 'block';
                    setTimeout(() => error.style.display = 'none', MESSAGE_TIMEOUT);
                }
            };

            window.closeBookingCreateModal = function() { document.getElementById('bookingCreateModal').style.display = 'none'; };

            window.showBookingEditForm = async function(bookingId) {
                const modal = document.getElementById('bookingEditModal');
                const success = document.getElementById('editBookingSuccess');
                const error = document.getElementById('editBookingError');
                success.style.display = 'none'; error.style.display = 'none';
                try {
                    const doc = await db.collection('bookings').doc(bookingId).get();
                    if (!doc.exists) { alert('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'); return; }
                    const b = doc.data();
                    document.getElementById('editBookingId').value = bookingId;
                    document.getElementById('editBookingFilm').value = b.film;
                    document.getElementById('editBookingDate').value = b.date;
                    document.getElementById('editBookingTime').value = b.time;
                    document.getElementById('editBookingOriginalSeat').value = b.seat;
                    document.getElementById('editBookingSeat').value = b.seat;
                    document.getElementById('editBookingCustomerName').value = b.customerName || '';
                    document.getElementById('editBookingCustomerPhone').value = b.customerPhone || '';
                    document.getElementById('editBookingPeople').value = b.people || 1;
                    document.getElementById('editBookingPrice').value = b.price || 0;
                    applyPeopleRangeForEdit(b.seat);
                    modal.style.display = 'block';
                    // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ + –≤—å—é–ø–æ—Ä—Ç
                    document.querySelector('#bookingEditModal .booking-create-modal-content').scrollTop = 0;
                } catch (e) { alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ' + e.message); }
            };

            window.closeBookingEditModal = function() { document.getElementById('bookingEditModal').style.display = 'none'; };

            window.updateBooking = async function() {
                const id = document.getElementById('editBookingId').value;
                const film = document.getElementById('editBookingFilm').value;
                const date = document.getElementById('editBookingDate').value;
                const time = document.getElementById('editBookingTime').value;
                const originalSeat = document.getElementById('editBookingOriginalSeat').value;
                const seat = document.getElementById('editBookingSeat').value.trim();
                const customerName = document.getElementById('editBookingCustomerName').value.trim();
                const customerPhone = document.getElementById('editBookingCustomerPhone').value.trim();
                const people = parseInt(document.getElementById('editBookingPeople').value);
                const price = parseInt(document.getElementById('editBookingPrice').value);
                const success = document.getElementById('editBookingSuccess');
                const error = document.getElementById('editBookingError');

                success.style.display = 'none'; error.style.display = 'none';
                if (!id || !film || !date || !time || !seat || !customerName || !customerPhone || !people || !price) {
                    error.textContent = ERROR_MESSAGES.INVALID_INPUT; error.style.display = 'block';
                    setTimeout(() => error.style.display = 'none', MESSAGE_TIMEOUT); return;
                }
                const type = getSeatTypeFromId(seat);
                const { min, max } = getPeopleRangeForSeatType(type);
                if (people < min || people > max) {
                    error.textContent = `–î–ª—è —ç—Ç–æ–≥–æ –º–µ—Å—Ç–∞ –¥–æ–ø—É—Å—Ç–∏–º–æ –æ—Ç ${min} –¥–æ ${max} —á–µ–ª–æ–≤–µ–∫.`; error.style.display = 'block';
                    setTimeout(() => error.style.display = 'none', MESSAGE_TIMEOUT); return;
                }

                try {
                    if (seat !== originalSeat) {
                        const snapshot = await db.collection('bookings')
                            .where('film', '==', film).where('date', '==', date).where('time', '==', time).where('seat', '==', seat).limit(1).get();
                        const takenByAnother = snapshot.docs.some(d => d.id !== id);
                        if (takenByAnother) {
                            error.textContent = '–ù–æ–≤–æ–µ –º–µ—Å—Ç–æ —É–∂–µ –∑–∞–Ω—è—Ç–æ!'; error.style.display = 'block';
                            setTimeout(() => error.style.display = 'none', MESSAGE_TIMEOUT); return;
                        }
                    }
                    await db.collection('bookings').doc(id).update({ seat, customerName, customerPhone, people, price });
                    success.style.display = 'block';
                    setTimeout(() => success.style.display = 'none', MESSAGE_TIMEOUT);
                    closeBookingEditModal();
                } catch (e) {
                    error.textContent = ERROR_MESSAGES.BOOKING_UPDATE_FAILED + e.message;
                    error.style.display = 'block';
                    setTimeout(() => error.style.display = 'none', MESSAGE_TIMEOUT);
                }
            };

            // Highlight
            window.highlightSeat = function(id, seat) {
                currentHighlightedBookingId = id;
                document.querySelectorAll('.hall-modal-seat').forEach(s => s.classList.remove('highlighted'));
                const el = document.querySelector(`.hall-modal-seat[data-seat="${seat}"]`);
                if (el) el.classList.add('highlighted');
            };

            window.closeHallSchemeModal = function() {
                document.getElementById('hallSchemeModal').style.display = 'none';
                currentHighlightedBookingId = null;
                if (typeof hallBookingsUnsub === 'function') { hallBookingsUnsub(); hallBookingsUnsub = null; }
            };

            // Archive
            window.clearArchive = async function() {
                if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∞—Ä—Ö–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è?')) {
                    try {
                        const todayStr = getTodayStr();
                        let batchCount = 0;
                        while (true) {
                            const snap = await db.collection('bookings').where('date', '<', todayStr).limit(500).get();
                            if (snap.empty) break;
                            const batch = db.batch();
                            snap.docs.forEach(d => batch.delete(db.collection('bookings').doc(d.id)));
                            await batch.commit();
                            batchCount += snap.docs.length;
                            if (snap.size < 500) break;
                        }
                        alert(`–ê—Ä—Ö–∏–≤ –æ—á–∏—â–µ–Ω. –£–¥–∞–ª–µ–Ω–æ: ${batchCount}`);
                    } catch (e) { alert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∞—Ä—Ö–∏–≤–∞: ' + e.message); }
                }
            };

            // Click outside to close modals
            window.onclick = function(e) {
                const m1 = document.getElementById('hallSchemeModal');
                const m2 = document.getElementById('bookingInfoModal');
                const m3 = document.getElementById('editMovieModal');
                const m4 = document.getElementById('bookingCreateModal');
                const m5 = document.getElementById('bookingEditModal');
                if (e.target === m1) closeHallSchemeModal();
                if (e.target === m2) closeBookingInfoModal();
                if (e.target === m3) closeEditMovieModal();
                if (e.target === m4) closeBookingCreateModal();
                if (e.target === m5) closeBookingEditModal();
            };

            // AUTO-CANCEL LOGIC
            function shouldAutoCancel(booking) {
                if (booking.confirmed === true) return false;
                if (!booking.date || !booking.time) return false;
                const seanceDT = parseLocalDateTime(booking.date, booking.time);
                const threshold = new Date(seanceDT.getTime() - 5 * 60 * 1000);
                return new Date() >= threshold;
            }
            async function autoCancelExpiredBookings(bookings) {
                const toDelete = bookings.filter(b => shouldAutoCancel(b));
                for (const b of toDelete) {
                    try { await db.collection('bookings').doc(b.id).delete(); } catch (e) {}
                }
            }
            function startAutoCancelWatcher() {
                const todayStr = getTodayStr();
                if (typeof todayAutoCancelUnsub === 'function') { todayAutoCancelUnsub(); todayAutoCancelUnsub = null; }
                if (autoCancelIntervalId) { clearInterval(autoCancelIntervalId); autoCancelIntervalId = null; }

                todayAutoCancelUnsub = db.collection('bookings').where('date', '==', todayStr).onSnapshot(snap => {
                    cachedTodayBookings = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                }, () => { cachedTodayBookings = []; });

                autoCancelIntervalId = setInterval(() => {
                    if (cachedTodayBookings.length) autoCancelExpiredBookings(cachedTodayBookings);
                }, 30000);
            }

        }
    </script>
</body>
</html>
